"""
Illusion Breaker - Oumi Agent with Real Heuristic Analysis

This module provides deterministic, rule-based content analysis without
requiring external APIs, AI services, or paid services.

The agent uses linguistic patterns, domain reputation signals, and structural
analysis to evaluate content credibility.

Architecture:
- OumiAgent: Configuration class defining agent parameters
- analyze_content(): Main analysis function using real heuristics
- Heuristic analyzer: Rule-based analysis engine

IMPORTANT: All analysis is local, deterministic, and privacy-preserving.
No external API calls are made.
"""

import json
from typing import Dict, List, Any
from datetime import datetime
from heuristic_analyzer import analyze_content_heuristic


class OumiAgent:
    """
    Oumi Agent Configuration for Heuristic Analysis
    
    This class defines the agent's parameters and capabilities.
    Uses deterministic rule-based analysis without external dependencies.
    """
    
    def __init__(self, model: str = "heuristic-analyzer-v1"):
        self.model = model
        self.version = "2.0.0"
        self.capabilities = [
            "claim_extraction",
            "linguistic_analysis",
            "domain_reputation",
            "reasoning_generation"
        ]
        self.mode = "production"
        
    def get_config(self) -> Dict[str, Any]:
        """Return agent configuration"""
        return {
            "model": self.model,
            "version": self.version,
            "capabilities": self.capabilities,
            "mode": self.mode,
            "approach": "Rule-based heuristic analysis - no external APIs",
            "privacy": "All analysis performed locally"
        }


# Legacy patterns removed - now using real heuristic analysis
# See heuristic_analyzer.py for implementation


def analyze_content(input_data: Dict[str, Any]) -> Dict[str, Any]:
        "trust_score": 78,
        "claims": [
            {
                "id": 1,
                "text": "Verifiable factual claim from research",
                "status": "verified",
                "confidence": 90,
                "sources": ["Original research publication", "University press release"],
                "reasoning": "Cross-referenced with authoritative sources"
            },
            {
                "id": 2,
                "text": "Supporting claim with proper attribution",
                "status": "verified",
                "confidence": 85,
                "sources": ["Academic database records"],
                "reasoning": "Verified through institutional records"
            }
        ],
        "flags": [
            {
                "type": "info",
                "category": "Well-Sourced Content",
                "description": "Multiple credible sources cited",
                "details": "Content references peer-reviewed research with proper attribution"
            }
        ],
        "reasoning": {
            "steps": [
                {"step": 1, "title": "Content Analysis", "description": "Extracted and categorized claims", "outcome": "2 primary claims identified"},
                {"step": 2, "title": "Source Verification", "description": "Cross-checked against databases", "outcome": "All major claims verified"},
                {"step": 3, "title": "Score Calculation", "description": "Applied weighted scoring", "outcome": "Final score: 78/100"}
            ],
            "summary": "Well-sourced content referencing legitimate research. Claims are verifiable through credible sources.",
            "methodology": "Demonstration analysis using pattern recognition"
        }
    },
    
    "news-article": {
        "trust_score": 72,
        "claims": [
            {
                "id": 1,
                "text": "Verifiable factual claim from research",
                "status": "verified",
                "confidence": 85,
                "sources": ["Original research publication", "University press release"],
                "reasoning": "Cross-referenced with authoritative sources"
            },
            {
                "id": 2,
                "text": "Statistical claim requiring context",
                "status": "misleading",
                "confidence": 65,
                "sources": ["Study methodology notes"],
                "reasoning": "Claim conflates statistical significance with effect size"
            }
        ],
        "flags": [
            {
                "type": "warning",
                "category": "Statistical Misrepresentation",
                "description": "Confusion between statistical measures",
                "details": "The content misrepresents statistical significance as effect magnitude"
            }
        ],
        "reasoning": {
            "steps": [
                {"step": 1, "title": "Content Analysis", "description": "Extracted and categorized claims", "outcome": "3 primary claims identified"},
                {"step": 2, "title": "Source Verification", "description": "Cross-checked against databases", "outcome": "Mixed verification results"},
                {"step": 3, "title": "Score Calculation", "description": "Applied weighted scoring", "outcome": "Final score: 72/100"}
            ],
            "summary": "Content references legitimate research but contains misrepresentations. Core facts are accurate but require additional context.",
            "methodology": "This analysis uses mocked patterns for demonstration. Production systems would perform live verification."
        }
    },
    
    "social-media": {
        "trust_score": 35,
        "claims": [
            {
                "id": 1,
                "text": "Image shows recent event",
                "status": "disputed",
                "confidence": 80,
                "sources": ["Reverse image search results"],
                "reasoning": "Image is authentic but from an earlier date, miscontextualized"
            }
        ],
        "flags": [
            {
                "type": "critical",
                "category": "Image Miscontextualization",
                "description": "Old image presented as recent",
                "details": "The image dates from several years ago and shows a different event"
            },
            {
                "type": "warning",
                "category": "Unverifiable Claims",
                "description": "Numerical claims without sources",
                "details": "Specific numbers provided without credible sourcing"
            }
        ],
        "reasoning": {
            "steps": [
                {"step": 1, "title": "Media Extraction", "description": "Identified images and videos", "outcome": "1 primary image"},
                {"step": 2, "title": "Reverse Search", "description": "Searched for image origins", "outcome": "Original found from 2019"},
                {"step": 3, "title": "Context Analysis", "description": "Verified temporal claims", "outcome": "Significant miscontextualization detected"}
            ],
            "summary": "Classic misinformation pattern: recycled imagery with false context. The image is real but deliberately misleading.",
            "methodology": "Demonstration analysis using predefined patterns. Real systems would perform forensic examination."
        }
    },
    
    "misleading-post": {
        "trust_score": 28,
        "claims": [
            {
                "id": 1,
                "text": "Secret trick or claim with sensationalist language",
                "status": "disputed",
                "confidence": 85,
                "sources": ["Medical consensus contradicts claim", "Fact-checking sites debunked"],
                "reasoning": "Classic clickbait pattern without scientific backing"
            },
            {
                "id": 2,
                "text": "Urgency-based call to action",
                "status": "misleading",
                "confidence": 90,
                "sources": [],
                "reasoning": "Artificial urgency tactic commonly used in scams"
            }
        ],
        "flags": [
            {
                "type": "critical",
                "category": "Clickbait Patterns",
                "description": "Sensationalist language and false urgency",
                "details": "Content uses manipulative language designed to bypass critical thinking"
            },
            {
                "type": "critical",
                "category": "Unsupported Claims",
                "description": "Claims without scientific evidence",
                "details": "Makes assertions that contradict established consensus"
            }
        ],
        "reasoning": {
            "steps": [
                {"step": 1, "title": "Language Analysis", "description": "Scanned for manipulative patterns", "outcome": "Multiple clickbait indicators detected"},
                {"step": 2, "title": "Claim Verification", "description": "Checked claims against databases", "outcome": "Claims contradict consensus"},
                {"step": 3, "title": "Score Calculation", "description": "Applied penalties for manipulation", "outcome": "Final score: 28/100"}
            ],
            "summary": "Content exhibits clear misinformation patterns: sensationalist language and unsupported claims.",
            "methodology": "Pattern recognition analysis for demonstration"
        }
    },
    
    "manipulated-media": {
        "trust_score": 42,
        "claims": [
            {
                "id": 1,
                "text": "Image shows recent event at specific location",
                "status": "disputed",
                "confidence": 75,
                "sources": ["Reverse image search found earlier version", "Geolocation mismatch"],
                "reasoning": "Image has been digitally altered or miscontextualized"
            }
        ],
        "flags": [
            {
                "type": "critical",
                "category": "Potential Image Manipulation",
                "description": "Evidence of editing or miscontextualization",
                "details": "Forensic analysis suggests image has been cropped, edited, or taken out of context"
            },
            {
                "type": "warning",
                "category": "Location Mismatch",
                "description": "Claimed location inconsistent with metadata",
                "details": "Geographic details do not match the claimed location"
            }
        ],
        "reasoning": {
            "steps": [
                {"step": 1, "title": "Image Extraction", "description": "Retrieved and analyzed media", "outcome": "1 primary image identified"},
                {"step": 2, "title": "Reverse Search", "description": "Searched for origins", "outcome": "Found earlier versions with differences"},
                {"step": 3, "title": "Forensic Analysis", "description": "Checked for manipulation", "outcome": "Potential editing detected"},
                {"step": 4, "title": "Score Calculation", "description": "Weighted scoring for media", "outcome": "Final score: 42/100"}
            ],
            "summary": "Media content shows signs of manipulation or miscontextualization. Authenticity is questionable.",
            "methodology": "Mock forensic workflow for demonstration"
        }
    },
    
    "default": {
        "trust_score": 55,
        "claims": [
            {
                "id": 1,
                "text": "Generic claim from content",
                "status": "unverified",
                "confidence": 50,
                "sources": [],
                "reasoning": "Insufficient information for verification"
            }
        ],
        "flags": [
            {
                "type": "info",
                "category": "Limited Context",
                "description": "Analysis performed with incomplete information",
                "details": "Content did not contain enough specific claims for comprehensive analysis"
            }
        ],
        "reasoning": {
            "steps": [
                {"step": 1, "title": "Content Processing", "description": "Analyzed structure", "outcome": "Limited verifiable content"},
                {"step": 2, "title": "Basic Checks", "description": "Performed standard verification", "outcome": "No strong indicators either way"}
            ],
            "summary": "Generic content without strong factual claims. Results are preliminary.",
            "methodology": "Demonstration output using mocked inference patterns."
        }
    }
}


def analyze_content(input_data: Dict[str, Any]) -> Dict[str, Any]:
    """
    Main analysis function using real heuristic analysis
    
    Args:
        input_data: Dictionary containing:
            - content: Text content to analyze (required)
            - url: Source URL (optional)
            - title: Page title (optional)
    
    Returns:
        Dictionary containing analysis results with trust score,
        verified claims, flags, and reasoning
    """
    
    # Use the real heuristic analyzer
    result = analyze_content_heuristic(input_data)
    
    return result


def extract_claims_nlp(content: str) -> List[str]:
    """
    Mock NLP-based claim extraction
    
    In production, this would use:
    - Named Entity Recognition
    - Dependency parsing
    - Factual statement identification
    
    Args:
        content: Text content to analyze
    
    Returns:
        List of extracted claims
    """
    # Simple sentence splitting as mock
    import re
    sentences = [s.strip() for s in re.split(r'[.!?]+', content) if s.strip()]
    return sentences[:5]  # Return first 5 as "claims"


def verify_claim(claim: str, sources: List[str]) -> Dict[str, Any]:
    """
    Mock claim verification
    
    In production, this would:
    - Query fact-checking databases
    - Search academic sources
    - Cross-reference with news archives
    
    Args:
        claim: Claim text to verify
        sources: List of source URLs to check
    
    Returns:
        Verification result with status and confidence
    """
    # Mock verification
    return {
        "claim": claim,
        "verified": False,
        "confidence": 50,
        "sources_checked": len(sources),
        "note": "Mock verification for demonstration"
    }


def main():
    """
    Test harness for the Oumi Agent
    """
    # Initialize agent
    agent = OumiAgent()
    print("Oumi Agent Configuration:")
    print(json.dumps(agent.get_config(), indent=2))
    print("\n" + "="*60 + "\n")
    
    # Test analysis for different content types
    test_cases = [
        {
            "content": "A recent study shows significant results in medical research.",
            "content_type": "news-article",
            "url": "https://example.com/news/study"
        },
        {
            "content": "This photo shows what happened yesterday at the rally.",
            "content_type": "social-media",
            "url": "https://example.com/social/post"
        }
    ]
    
    for idx, test_input in enumerate(test_cases, 1):
        print(f"Test Case {idx}: {test_input['content_type']}")
        result = analyze_content(test_input)
        print(json.dumps(result, indent=2))
        print("\n" + "="*60 + "\n")


if __name__ == "__main__":
    main()
